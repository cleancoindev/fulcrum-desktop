{"version":3,"sources":["../../src/commands/command.js"],"names":["longStackTraces","config","JSON","parse","readFileSync","join","toString","Command","setup","initialize","_db","destroy","close","shutdown","db","args","argv","fetchAccount","name","where","organization_name","accounts","findAll","createDataSource","account","dataSource","localDatabase","add","load","start","run","err","console","error","stack"],"mappings":";;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;AACA;;AACA;;;;;;;;AAEA,mBAAQA,eAAR;;AAEA,MAAMC,SAASC,KAAKC,KAAL,CAAW,aAAGC,YAAH,CAAgB,eAAKC,IAAL,CAAU,MAAV,EAAkB,aAAlB,CAAhB,EAAkDC,QAAlD,EAAX,CAAf;;AAEe,MAAMC,OAAN,CAAc;AACrBC,OAAN,GAAc;AAAA;;AAAA;AACZ,YAAM,cAAIC,UAAJ,EAAN;AACA,YAAKC,GAAL,GAAW,MAAM,wBAAS,MAAKT,MAAd,CAAjB;AAFY;AAGb;;AAEKU,SAAN,GAAgB;AAAA;;AAAA;AACd,YAAM,OAAKD,GAAL,CAASE,KAAT,EAAN;;AAEA,uBAASC,QAAT;AAHc;AAIf;;AAED,MAAIC,EAAJ,GAAS;AACP,WAAO,KAAKJ,GAAZ;AACD;;AAED,MAAIK,IAAJ,GAAW;AACT,WAAO,gBAAMC,IAAb;AACD;;AAED,MAAIf,MAAJ,GAAa;AACX,WAAOA,MAAP;AACD;;AAEKgB,cAAN,CAAmBC,IAAnB,EAAyB;AAAA;;AAAA;AACvB,YAAMC,QAAQ,EAAd;;AAEA,UAAID,IAAJ,EAAU;AACRC,cAAMC,iBAAN,GAA0BF,IAA1B;AACD;;AAED,YAAMG,WAAW,MAAM,kBAAQC,OAAR,CAAgB,OAAKR,EAArB,EAAyBK,KAAzB,CAAvB;;AAEA,aAAOE,QAAP;AATuB;AAUxB;;AAEKE,kBAAN,CAAuBC,OAAvB,EAAgC;AAAA;;AAAA;AAC9B,UAAIC,aAAa,6BAAjB;;AAEA,YAAMC,gBAAgB,sCAA4BF,OAA5B,CAAtB;;AAEAC,iBAAWE,GAAX,CAAeD,aAAf;;AAEA,YAAMA,cAAcE,IAAd,CAAmB,OAAKd,EAAxB,CAAN;;AAEA,aAAOW,UAAP;AAT8B;AAU/B;;AAEKI,OAAN,GAAc;AAAA;;AAAA;AACZ,UAAI;AACF,cAAM,OAAKrB,KAAL,EAAN;AACA,cAAM,OAAKsB,GAAL,EAAN;AACA,cAAM,OAAKnB,OAAL,EAAN;AACD,OAJD,CAIE,OAAOoB,GAAP,EAAY;AACZC,gBAAQC,KAAR,CAAcF,IAAIG,KAAlB;AACA;AACA;AACA;AACA;AACA;;AAEA,cAAM,OAAKvB,OAAL,EAAN;AACD;AAdW;AAeb;AA/D0B;kBAARJ,O","file":"command.js","sourcesContent":["import 'colors';\nimport yargs from 'yargs';\nimport Promise from 'bluebird';\nimport Account from '../models/account';\nimport database from '../db/database';\nimport fs from 'fs';\nimport path from 'path';\nimport { DataSource } from 'fulcrum-core';\nimport LocalDatabaseDataSource from '../local-database-data-source';\nimport { Postgres } from 'minidb';\nimport app from '../app';\n\nPromise.longStackTraces();\n\nconst config = JSON.parse(fs.readFileSync(path.join('data', 'config.json')).toString());\n\nexport default class Command {\n  async setup() {\n    await app.initialize();\n    this._db = await database(this.config);\n  }\n\n  async destroy() {\n    await this._db.close();\n\n    Postgres.shutdown();\n  }\n\n  get db() {\n    return this._db;\n  }\n\n  get args() {\n    return yargs.argv;\n  }\n\n  get config() {\n    return config;\n  }\n\n  async fetchAccount(name) {\n    const where = {};\n\n    if (name) {\n      where.organization_name = name;\n    }\n\n    const accounts = await Account.findAll(this.db, where);\n\n    return accounts;\n  }\n\n  async createDataSource(account) {\n    let dataSource = new DataSource();\n\n    const localDatabase = new LocalDatabaseDataSource(account);\n\n    dataSource.add(localDatabase);\n\n    await localDatabase.load(this.db);\n\n    return dataSource;\n  }\n\n  async start() {\n    try {\n      await this.setup();\n      await this.run();\n      await this.destroy();\n    } catch (err) {\n      console.error(err.stack);\n      // if (this.args.verbose) {\n      //   console.error(err.stack);\n      // } else {\n      //   console.error(err.message);\n      // }\n\n      await this.destroy();\n    }\n  }\n}\n"]}