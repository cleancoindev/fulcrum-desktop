{"version":3,"sources":["../../../src/sync/tasks/download-records.js"],"names":["DownloadRecords","constructor","form","args","run","account","dataSource","sync","checkSyncState","id","needsUpdate","downloadRecordPage","_lastSync","page","total","lastSync","beginFetchTime","Date","progress","message","downloading","name","blue","yellow","results","getRecords","getRecordsHistory","totalFetchTime","getTime","statusCode","console","log","organizationName","green","red","data","JSON","parse","body","objects","records","db","now","processing","total_pages","count","length","transaction","database","index","attributes","object","findOrCreate","account_id","rowID","resource_id","history_change_type","_form","_formRowID","delete","trigger","record","isChanged","isPersisted","version","updateFromAPIAttributes","updatedAt","project_id","project","projectByResourceID","_projectRowID","save","totalTime","finished","cyan","update"],"mappings":"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","file":"download-records.js","sourcesContent":["import Task from './task';\nimport Client from '../../api/Client';\nimport Record from '../../models/record';\nimport {format} from 'util';\n\nexport default class DownloadRecords extends Task {\n  constructor({form, ...args}) {\n    super(args);\n\n    this.form = form;\n  }\n\n  async run({account, dataSource}) {\n    const sync = await this.checkSyncState(account, 'records', this.form.id);\n\n    if (!sync.needsUpdate) {\n      return;\n    }\n\n    await this.downloadRecordPage(account, this.form, 1, null, this.form._lastSync, sync);\n  }\n\n  async downloadRecordPage(account, form, page, total, lastSync, sync) {\n    const beginFetchTime = new Date();\n\n    this.progress({message: this.downloading + ' ' + this.form.name.blue + ' ' + format('page %s', page).yellow});\n\n    const results = lastSync == null ? (await Client.getRecords(account, form, page))\n                                     : (await Client.getRecordsHistory(account, form, page, lastSync));\n\n    const totalFetchTime = new Date().getTime() - beginFetchTime.getTime();\n\n    if (results.statusCode !== 200) {\n      console.log(account.organizationName.green, 'failed'.red, 'to download records in', form.name.blue);\n      return;\n    }\n\n    const data = JSON.parse(results.body);\n\n    const objects = data.records;\n\n    const db = account.db;\n\n    let now = new Date();\n\n    this.progress({message: this.processing + ' ' + this.form.name.blue + ' ' + format('page %s/%s', page, data.total_pages || 1).yellow, count: 0, total: objects.length});\n\n    await db.transaction(async (database) => {\n      for (let index = 0; index < objects.length; ++index) {\n        const attributes = objects[index];\n\n        const object = await Record.findOrCreate(database, {account_id: account.rowID, resource_id: attributes.id});\n\n        if (attributes.history_change_type === 'd') {\n          if (object) {\n            object._form = form;\n            object._formRowID = form.rowID;\n\n            await object.delete();\n\n            await this.trigger('record:delete', {record: object});\n          }\n        } else {\n          const isChanged = !object.isPersisted || attributes.version !== object.version;\n\n          object.updateFromAPIAttributes(attributes);\n          object._form = form;\n          object._formRowID = form.rowID;\n\n          form._lastSync = object.updatedAt;\n\n          if (attributes.project_id) {\n            const project = await account.projectByResourceID(attributes.project_id);\n\n            if (project) {\n              object._projectRowID = project.rowID;\n            }\n          }\n\n          await object.save();\n\n          if (isChanged) {\n            await this.trigger('record:save', {record: object});\n          }\n        }\n\n        this.progress({message: this.processing + ' ' + this.form.name.blue + ' ' + format('page %s/%s', page, data.total_pages || 1).yellow, count: index + 1, total: objects.length});\n      }\n    });\n\n    const totalTime = new Date().getTime() - now.getTime();\n\n    // update the lastSync date\n    await form.save();\n\n    const message = format(this.finished + ' %s | %s | %s | %s',\n                           form.name.blue,\n                           format('%s/%s', page, data.total_pages || 1).yellow,\n                           (totalFetchTime + 'ms').cyan,\n                           (totalTime + 'ms').red);\n\n    this.progress({message, count: objects.length, total: objects.length});\n\n    if (data.total_pages > page) {\n      await this.downloadRecordPage(account, form, page + 1, data.total_pages, lastSync, sync);\n    } else {\n      await sync.update();\n    }\n  }\n}\n"]}