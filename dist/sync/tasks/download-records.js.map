{"version":3,"sources":["../../../src/sync/tasks/download-records.js"],"names":["DownloadRecords","constructor","form","args","syncResourceName","syncResourceScope","id","syncLabel","name","resourceName","lastSync","_lastSync","fetchObjects","account","sequence","getRecords","pageSize","getRecordsHistory","findOrCreate","database","attributes","account_id","rowID","resource_id","process","object","history_change_type","_form","_formRowID","delete","_hasChanges","trigger","record","isChanged","isPersisted","version","updateFromAPIAttributes","updatedAt","lookup","project_id","assigned_to_id","created_by_id","updated_by_id","save","finish","fail","results","console","log","organizationName","green","red"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;;;;;;;AAEe,MAAMA,eAAN,oCAA+C;AAC5DC,oBAA6B;AAAA,QAAjB,EAACC,IAAD,EAAiB;AAAA,QAAPC,IAAO;;AAC3B,UAAMA,IAAN;;AAEA,SAAKD,IAAL,GAAYA,IAAZ;AACD;;AAED,MAAIE,gBAAJ,GAAuB;AACrB,WAAO,SAAP;AACD;;AAED,MAAIC,iBAAJ,GAAwB;AACtB,WAAO,KAAKH,IAAL,CAAUI,EAAjB;AACD;;AAED,MAAIC,SAAJ,GAAgB;AACd,WAAO,KAAKL,IAAL,CAAUM,IAAjB;AACD;;AAED,MAAIC,YAAJ,GAAmB;AACjB,WAAO,SAAP;AACD;;AAED,MAAIC,QAAJ,GAAe;AACb,WAAO,KAAKR,IAAL,CAAUS,SAAjB;AACD;;AAEKC,cAAN,CAAmBC,OAAnB,EAA4BH,QAA5B,EAAsCI,QAAtC,EAAgD;AAAA;;AAAA;AAC9C,aAAOJ,YAAY,IAAZ,GAAoB,MAAM,iBAAOK,UAAP,CAAkBF,OAAlB,EAA2B,MAAKX,IAAhC,EAAsCY,QAAtC,EAAgD,MAAKE,QAArD,CAA1B,GACoB,MAAM,iBAAOC,iBAAP,CAAyBJ,OAAzB,EAAkC,MAAKX,IAAvC,EAA6CY,QAA7C,EAAuD,MAAKE,QAA5D,CADjC;AAD8C;AAG/C;;AAEDE,eAAaC,QAAb,EAAuBN,OAAvB,EAAgCO,UAAhC,EAA4C;AAC1C,WAAO,iBAAOF,YAAP,CAAoBC,QAApB,EAA8B,EAACE,YAAYR,QAAQS,KAArB,EAA4BC,aAAaH,WAAWd,EAApD,EAA9B,CAAP;AACD;;AAEKkB,SAAN,CAAcC,MAAd,EAAsBL,UAAtB,EAAkC;AAAA;;AAAA;AAChC,UAAIA,WAAWM,mBAAX,KAAmC,GAAvC,EAA4C;AAC1C,YAAID,MAAJ,EAAY;AACVA,iBAAOE,KAAP,GAAe,OAAKzB,IAApB;AACAuB,iBAAOG,UAAP,GAAoB,OAAK1B,IAAL,CAAUoB,KAA9B;;AAEA,gBAAMG,OAAOI,MAAP,EAAN;;AAEA,iBAAKC,WAAL,GAAmB,IAAnB;;AAEA,gBAAM,OAAKC,OAAL,CAAa,eAAb,EAA8B,EAACC,QAAQP,MAAT,EAA9B,CAAN;AACD;AACF,OAXD,MAWO;AACL,cAAMQ,YAAY,CAACR,OAAOS,WAAR,IAAuBd,WAAWe,OAAX,KAAuBV,OAAOU,OAAvE;;AAEAV,eAAOW,uBAAP,CAA+BhB,UAA/B;AACAK,eAAOE,KAAP,GAAe,OAAKzB,IAApB;AACAuB,eAAOG,UAAP,GAAoB,OAAK1B,IAAL,CAAUoB,KAA9B;;AAEA,eAAKpB,IAAL,CAAUS,SAAV,GAAsBc,OAAOY,SAA7B;;AAEA,cAAM,OAAKC,MAAL,CAAYb,MAAZ,EAAoBL,WAAWmB,UAA/B,EAA2C,eAA3C,EAA4D,YAA5D,CAAN;AACA,cAAM,OAAKD,MAAL,CAAYb,MAAZ,EAAoBL,WAAWoB,cAA/B,EAA+C,kBAA/C,EAAmE,SAAnE,CAAN;AACA,cAAM,OAAKF,MAAL,CAAYb,MAAZ,EAAoBL,WAAWqB,aAA/B,EAA8C,iBAA9C,EAAiE,SAAjE,CAAN;AACA,cAAM,OAAKH,MAAL,CAAYb,MAAZ,EAAoBL,WAAWsB,aAA/B,EAA8C,iBAA9C,EAAiE,SAAjE,CAAN;;AAEA,cAAMjB,OAAOkB,IAAP,EAAN;;AAEA,YAAIV,SAAJ,EAAe;AACb,iBAAKH,WAAL,GAAmB,IAAnB;AACA,gBAAM,OAAKC,OAAL,CAAa,aAAb,EAA4B,EAACC,QAAQP,MAAT,EAA5B,CAAN;AACD;AACF;AAhC+B;AAiCjC;;AAEKmB,QAAN,GAAe;AAAA;;AAAA;AACb;AACA,YAAM,OAAK1C,IAAL,CAAUyC,IAAV,EAAN;;AAEA,UAAI,OAAKb,WAAT,EAAsB;AACpB,cAAM,OAAKC,OAAL,CAAa,gBAAb,EAA+B,EAAC7B,MAAM,OAAKA,IAAZ,EAA/B,CAAN;AACD;AANY;AAOd;;AAED2C,OAAKhC,OAAL,EAAciC,OAAd,EAAuB;AACrBC,YAAQC,GAAR,CAAYnC,QAAQoC,gBAAR,CAAyBC,KAArC,EAA4C,SAASC,GAArD;AACD;AAlF2D;kBAAzCnD,e","file":"download-records.js","sourcesContent":["import DownloadSequence from './download-sequence';\nimport Client from '../../api/client';\nimport Record from '../../models/record';\n\nexport default class DownloadRecords extends DownloadSequence {\n  constructor({form, ...args}) {\n    super(args);\n\n    this.form = form;\n  }\n\n  get syncResourceName() {\n    return 'records';\n  }\n\n  get syncResourceScope() {\n    return this.form.id;\n  }\n\n  get syncLabel() {\n    return this.form.name;\n  }\n\n  get resourceName() {\n    return 'records';\n  }\n\n  get lastSync() {\n    return this.form._lastSync;\n  }\n\n  async fetchObjects(account, lastSync, sequence) {\n    return lastSync == null ? (await Client.getRecords(account, this.form, sequence, this.pageSize))\n                            : (await Client.getRecordsHistory(account, this.form, sequence, this.pageSize));\n  }\n\n  findOrCreate(database, account, attributes) {\n    return Record.findOrCreate(database, {account_id: account.rowID, resource_id: attributes.id});\n  }\n\n  async process(object, attributes) {\n    if (attributes.history_change_type === 'd') {\n      if (object) {\n        object._form = this.form;\n        object._formRowID = this.form.rowID;\n\n        await object.delete();\n\n        this._hasChanges = true;\n\n        await this.trigger('record:delete', {record: object});\n      }\n    } else {\n      const isChanged = !object.isPersisted || attributes.version !== object.version;\n\n      object.updateFromAPIAttributes(attributes);\n      object._form = this.form;\n      object._formRowID = this.form.rowID;\n\n      this.form._lastSync = object.updatedAt;\n\n      await this.lookup(object, attributes.project_id, '_projectRowID', 'getProject');\n      await this.lookup(object, attributes.assigned_to_id, '_assignedToRowID', 'getUser');\n      await this.lookup(object, attributes.created_by_id, '_createdByRowID', 'getUser');\n      await this.lookup(object, attributes.updated_by_id, '_updatedByRowID', 'getUser');\n\n      await object.save();\n\n      if (isChanged) {\n        this._hasChanges = true;\n        await this.trigger('record:save', {record: object});\n      }\n    }\n  }\n\n  async finish() {\n    // update the lastSync date\n    await this.form.save();\n\n    if (this._hasChanges) {\n      await this.trigger('records:finish', {form: this.form});\n    }\n  }\n\n  fail(account, results) {\n    console.log(account.organizationName.green, 'failed'.red);\n  }\n}\n"]}