{"version":3,"sources":["../../../src/sync/tasks/download-changesets.js"],"names":["DownloadChangesets","syncResourceName","syncLabel","resourceName","lastSync","account","_lastSyncChangesets","fetchObjects","sequence","getChangesets","pageSize","findOrCreate","database","attributes","account_id","rowID","resource_id","id","process","object","updateFromAPIAttributes","isChanged","isPersisted","parseISOTimestamp","updated_at","getTime","updatedAt","lookup","form_id","closed_by_id","created_by_id","_updatedAt","save","trigger","changeset","finish","fail","results","console","log","organizationName","green","red"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEe,MAAMA,kBAAN,oCAAkD;AAC/D,MAAIC,gBAAJ,GAAuB;AACrB,WAAO,YAAP;AACD;;AAED,MAAIC,SAAJ,GAAgB;AACd,WAAO,YAAP;AACD;;AAED,MAAIC,YAAJ,GAAmB;AACjB,WAAO,YAAP;AACD;;AAED,MAAIC,QAAJ,GAAe;AACb,WAAO,KAAKC,OAAL,CAAaC,mBAApB;AACD;;AAEKC,cAAN,CAAmBF,OAAnB,EAA4BD,QAA5B,EAAsCI,QAAtC,EAAgD;AAAA;;AAAA;AAC9C,aAAO,iBAAOC,aAAP,CAAqBJ,OAArB,EAA8BG,QAA9B,EAAwC,MAAKE,QAA7C,CAAP;AAD8C;AAE/C;;AAEDC,eAAaC,QAAb,EAAuBP,OAAvB,EAAgCQ,UAAhC,EAA4C;AAC1C,WAAO,oBAAUF,YAAV,CAAuBC,QAAvB,EAAiC,EAACE,YAAYT,QAAQU,KAArB,EAA4BC,aAAaH,WAAWI,EAApD,EAAjC,CAAP;AACD;;AAEKC,SAAN,CAAcC,MAAd,EAAsBN,UAAtB,EAAkC;AAAA;;AAAA;AAChCM,aAAOC,uBAAP,CAA+BP,UAA/B;;AAEA,YAAMQ,YAAY,CAACF,OAAOG,WAAR,IACA,uBAAUC,iBAAV,CAA4BV,WAAWW,UAAvC,EAAmDC,OAAnD,OAAiEN,OAAOO,SAAP,CAAiBD,OAAjB,EADnF;;AAGA,YAAM,OAAKE,MAAL,CAAYR,MAAZ,EAAoBN,WAAWe,OAA/B,EAAwC,YAAxC,EAAsD,SAAtD,CAAN;AACA,YAAM,OAAKD,MAAL,CAAYR,MAAZ,EAAoBN,WAAWgB,YAA/B,EAA6C,gBAA7C,EAA+D,SAA/D,CAAN;AACA,YAAM,OAAKF,MAAL,CAAYR,MAAZ,EAAoBN,WAAWiB,aAA/B,EAA8C,iBAA9C,EAAiE,SAAjE,CAAN;;AAEA,aAAKzB,OAAL,CAAaC,mBAAb,GAAmCa,OAAOY,UAA1C;;AAEA,YAAMZ,OAAOa,IAAP,EAAN;;AAEA,UAAIX,SAAJ,EAAe;AACb,cAAM,OAAKY,OAAL,CAAa,gBAAb,EAA+B,EAACC,WAAWf,MAAZ,EAA/B,CAAN;AACD;AAhB+B;AAiBjC;;AAEKgB,QAAN,GAAe;AAAA;;AAAA;AACb;AACA,YAAM,OAAK9B,OAAL,CAAa2B,IAAb,EAAN;AAFa;AAGd;;AAEDI,OAAK/B,OAAL,EAAcgC,OAAd,EAAuB;AACrBC,YAAQC,GAAR,CAAYlC,QAAQmC,gBAAR,CAAyBC,KAArC,EAA4C,SAASC,GAArD;AACD;AAnD8D;kBAA5C1C,kB","file":"download-changesets.js","sourcesContent":["import DownloadSequence from './download-sequence';\nimport Client from '../../api/client';\nimport Changeset from '../../models/changeset';\nimport { DateUtils } from 'fulcrum-core';\n\nexport default class DownloadChangesets extends DownloadSequence {\n  get syncResourceName() {\n    return 'changesets';\n  }\n\n  get syncLabel() {\n    return 'changesets';\n  }\n\n  get resourceName() {\n    return 'changesets';\n  }\n\n  get lastSync() {\n    return this.account._lastSyncChangesets;\n  }\n\n  async fetchObjects(account, lastSync, sequence) {\n    return Client.getChangesets(account, sequence, this.pageSize);\n  }\n\n  findOrCreate(database, account, attributes) {\n    return Changeset.findOrCreate(database, {account_id: account.rowID, resource_id: attributes.id});\n  }\n\n  async process(object, attributes) {\n    object.updateFromAPIAttributes(attributes);\n\n    const isChanged = !object.isPersisted ||\n                      DateUtils.parseISOTimestamp(attributes.updated_at).getTime() !== object.updatedAt.getTime();\n\n    await this.lookup(object, attributes.form_id, '_formRowID', 'getForm');\n    await this.lookup(object, attributes.closed_by_id, '_closedByRowID', 'getUser');\n    await this.lookup(object, attributes.created_by_id, '_createdByRowID', 'getUser');\n\n    this.account._lastSyncChangesets = object._updatedAt;\n\n    await object.save();\n\n    if (isChanged) {\n      await this.trigger('changeset:save', {changeset: object});\n    }\n  }\n\n  async finish() {\n    // update the lastSync date\n    await this.account.save();\n  }\n\n  fail(account, results) {\n    console.log(account.organizationName.green, 'failed'.red);\n  }\n}\n"]}