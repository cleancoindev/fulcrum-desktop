{"version":3,"sources":["../../src/sync/synchronizer.js"],"names":["require","Synchronizer","constructor","_tasks","addTask","task","push","popTask","shift","run","account","formName","dataSource","fullSync","start","Date","getTime","response","getSync","syncState","JSON","parse","body","resources","taskParams","synchronizer","source","load","db","execute","length","console","log"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AAEA;;;;;;;;AAEA;AACA;;AAEAA,QAAQ,QAAR;;AAEe,MAAMC,YAAN,CAAmB;AAChCC,gBAAc;AACZ,SAAKC,MAAL,GAAc,EAAd;AACD;;AAEDC,UAAQC,IAAR,EAAc;AACZ,SAAKF,MAAL,CAAYG,IAAZ,CAAiBD,IAAjB;AACD;;AAEDE,YAAU;AACR,WAAO,KAAKJ,MAAL,CAAYK,KAAZ,EAAP;AACD;;AAEKC,KAAN,CAAUC,OAAV,EAAmBC,QAAnB,EAA6BC,UAA7B,EAAyC,EAACC,QAAD,EAAzC,EAAqD;AAAA;;AAAA;AACnD,YAAMC,QAAQ,IAAIC,IAAJ,GAAWC,OAAX,EAAd;;AAEA,YAAMC,WAAW,MAAM,iBAAOC,OAAP,CAAeR,OAAf,CAAvB;;AAEA,YAAKS,SAAL,GAAiBN,WAAW,EAAX,GAAgBO,KAAKC,KAAL,CAAWJ,SAASK,IAApB,EAA0BC,SAA3D;AACA,YAAKC,UAAL,GAAkB,EAAEC,mBAAF,EAAsBN,WAAW,MAAKA,SAAtC,EAAlB;;AAEA,YAAKf,OAAL,CAAa,4BAAkB,MAAKoB,UAAvB,CAAb;AACA,YAAKpB,OAAL,CAAa,kCAAwB,MAAKoB,UAA7B,CAAb;AACA,YAAKpB,OAAL,CAAa,kCAAwB,MAAKoB,UAA7B,CAAb;AACA,YAAKpB,OAAL,CAAa,yCAA+B,MAAKoB,UAApC,CAAb;AACA,YAAKpB,OAAL,CAAa,+BAAqB,MAAKoB,UAA1B,CAAb;AACA,YAAKpB,OAAL,CAAa,4BAAkB,MAAKoB,UAAvB,CAAb;AACA,YAAKpB,OAAL,CAAa,iCAAuB,MAAKoB,UAA5B,CAAb;AACA,YAAKpB,OAAL,CAAa,iCAAuB,MAAKoB,UAA5B,CAAb;;AAEA,YAAMZ,WAAWc,MAAX,CAAkBC,IAAlB,CAAuBjB,QAAQkB,EAA/B,CAAN;;AAEA,SAAG;AACD,cAAMvB,OAAO,MAAKE,OAAL,EAAb;;AAEA,cAAMF,KAAKwB,OAAL,CAAa,EAACnB,OAAD,EAAUE,UAAV,EAAb,CAAN;AACD,OAJD,QAIS,MAAKT,MAAL,CAAY2B,MAJrB;;AAMAC,cAAQC,GAAR,CAAY,QAAZ,EAAsB,gCAAiB,IAAIjB,IAAJ,GAAWC,OAAX,KAAuBF,KAAxC,CAAtB;AAzBmD;AA0BpD;AAvC+B;kBAAbb,Y","file":"synchronizer.js","sourcesContent":["import DownloadRoles from './tasks/download-roles';\nimport DownloadMemberships from './tasks/download-memberships';\nimport DownloadChoiceLists from './tasks/download-choice-lists';\nimport DownloadClassificationSets from './tasks/download-classification-sets';\nimport DownloadProjects from './tasks/download-projects';\nimport DownloadForms from './tasks/download-forms';\nimport DownloadChangesets from './tasks/download-changesets';\nimport DownloadAllRecords from './tasks/download-all-records';\n\nimport Client from '../api/client';\n\nimport humanizeDuration from 'humanize-duration';\n\n// import { Database } from 'minidb';\n// Database.debug = true;\n\nrequire('colors');\n\nexport default class Synchronizer {\n  constructor() {\n    this._tasks = [];\n  }\n\n  addTask(task) {\n    this._tasks.push(task);\n  }\n\n  popTask() {\n    return this._tasks.shift();\n  }\n\n  async run(account, formName, dataSource, {fullSync}) {\n    const start = new Date().getTime();\n\n    const response = await Client.getSync(account);\n\n    this.syncState = fullSync ? [] : JSON.parse(response.body).resources;\n    this.taskParams = { synchronizer: this, syncState: this.syncState };\n\n    this.addTask(new DownloadRoles(this.taskParams));\n    this.addTask(new DownloadMemberships(this.taskParams));\n    this.addTask(new DownloadChoiceLists(this.taskParams));\n    this.addTask(new DownloadClassificationSets(this.taskParams));\n    this.addTask(new DownloadProjects(this.taskParams));\n    this.addTask(new DownloadForms(this.taskParams));\n    this.addTask(new DownloadChangesets(this.taskParams));\n    this.addTask(new DownloadAllRecords(this.taskParams));\n\n    await dataSource.source.load(account.db);\n\n    do {\n      const task = this.popTask();\n\n      await task.execute({account, dataSource});\n    } while (this._tasks.length);\n\n    console.log('Synced', humanizeDuration(new Date().getTime() - start));\n  }\n}\n"]}