{"version":3,"sources":["../../src/sync/synchronizer.js"],"names":["require","getUserHome","process","env","platform","mediaPath","join","sync","Synchronizer","constructor","_tasks","addTask","task","push","popTask","shift","run","account","formName","dataSource","fullSync","start","Date","getTime","response","getSync","syncState","JSON","parse","body","resources","taskParams","synchronizer","source","load","db","execute","length","console","log"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AACA;;;;AACA;;;;AAIA;;;;;;;;AAFA;AACA;;;AAEA;;AAEA;;AAEAA,QAAQ,QAAR;;AAEA,SAASC,WAAT,GAAuB;AACrB,SAAOC,QAAQC,GAAR,CAAaD,QAAQE,QAAR,KAAqB,OAAtB,GAAiC,aAAjC,GAAiD,MAA7D,CAAP;AACD;;AAED,MAAMC,YAAY,eAAKC,IAAL,CAAUL,aAAV,EAAyB,WAAzB,EAAsC,eAAtC,CAAlB;;AAEA,iBAAOM,IAAP,CAAYF,SAAZ;AACA,iBAAOE,IAAP,CAAY,eAAKD,IAAL,CAAUD,SAAV,EAAqB,QAArB,CAAZ;AACA,iBAAOE,IAAP,CAAY,eAAKD,IAAL,CAAUD,SAAV,EAAqB,QAArB,CAAZ;AACA,iBAAOE,IAAP,CAAY,eAAKD,IAAL,CAAUD,SAAV,EAAqB,OAArB,CAAZ;AACA,iBAAOE,IAAP,CAAY,eAAKD,IAAL,CAAUD,SAAV,EAAqB,SAArB,CAAZ;;AAEA;;AAEe,MAAMG,YAAN,CAAmB;AAChCC,gBAAc;AACZ,SAAKC,MAAL,GAAc,EAAd;AACD;;AAEDC,UAAQC,IAAR,EAAc;AACZ,SAAKF,MAAL,CAAYG,IAAZ,CAAiBD,IAAjB;AACD;;AAEDE,YAAU;AACR,WAAO,KAAKJ,MAAL,CAAYK,KAAZ,EAAP;AACD;;AAEKC,KAAN,CAAUC,OAAV,EAAmBC,QAAnB,EAA6BC,UAA7B,EAAyC,EAACC,QAAD,EAAzC,EAAqD;AAAA;;AAAA;AACnD,YAAMC,QAAQ,IAAIC,IAAJ,GAAWC,OAAX,EAAd;;AAEA,YAAMC,WAAW,MAAM,iBAAOC,OAAP,CAAeR,OAAf,CAAvB;;AAEA,YAAKS,SAAL,GAAiBN,WAAW,EAAX,GAAgBO,KAAKC,KAAL,CAAWJ,SAASK,IAApB,EAA0BC,SAA3D;AACA,YAAKC,UAAL,GAAkB,EAAEC,mBAAF,EAAsBN,WAAW,MAAKA,SAAtC,EAAlB;;AAEA,YAAKf,OAAL,CAAa,4BAAkB,MAAKoB,UAAvB,CAAb;AACA,YAAKpB,OAAL,CAAa,kCAAwB,MAAKoB,UAA7B,CAAb;AACA,YAAKpB,OAAL,CAAa,kCAAwB,MAAKoB,UAA7B,CAAb;AACA,YAAKpB,OAAL,CAAa,yCAA+B,MAAKoB,UAApC,CAAb;AACA,YAAKpB,OAAL,CAAa,+BAAqB,MAAKoB,UAA1B,CAAb;AACA,YAAKpB,OAAL,CAAa,4BAAkB,MAAKoB,UAAvB,CAAb;AACA,YAAKpB,OAAL,CAAa,iCAAuB,MAAKoB,UAA5B,CAAb;;AAEA,YAAMZ,WAAWc,MAAX,CAAkBC,IAAlB,CAAuBjB,QAAQkB,EAA/B,CAAN;;AAEA,SAAG;AACD,cAAMvB,OAAO,MAAKE,OAAL,EAAb;;AAEA,cAAMF,KAAKwB,OAAL,CAAa,EAACnB,OAAD,EAAUE,UAAV,EAAb,CAAN;AACD,OAJD,QAIS,MAAKT,MAAL,CAAY2B,MAJrB;;AAMAC,cAAQC,GAAR,CAAY,QAAZ,EAAsB,gCAAiB,IAAIjB,IAAJ,GAAWC,OAAX,KAAuBF,KAAxC,CAAtB;AAxBmD;AAyBpD;AAtC+B;kBAAbb,Y","file":"synchronizer.js","sourcesContent":["import DownloadRoles from './tasks/download-roles';\nimport DownloadMemberships from './tasks/download-memberships';\nimport DownloadChoiceLists from './tasks/download-choice-lists';\nimport DownloadClassificationSets from './tasks/download-classification-sets';\nimport DownloadProjects from './tasks/download-projects';\nimport DownloadForms from './tasks/download-forms';\nimport DownloadAllRecords from './tasks/download-all-records';\n\nimport Client from '../api/Client';\nimport path from 'path';\nimport mkdirp from 'mkdirp';\n\n// import exif from 'exif';\n// import Generator from '../reports/generator';\nimport humanizeDuration from 'humanize-duration';\n// import { Database } from 'minidb';\n\n// Database.debug = true;\n\nrequire('colors');\n\nfunction getUserHome() {\n  return process.env[(process.platform === 'win32') ? 'USERPROFILE' : 'HOME'];\n}\n\nconst mediaPath = path.join(getUserHome(), 'Documents', 'fulcrum-media');\n\nmkdirp.sync(mediaPath);\nmkdirp.sync(path.join(mediaPath, 'videos'));\nmkdirp.sync(path.join(mediaPath, 'photos'));\nmkdirp.sync(path.join(mediaPath, 'audio'));\nmkdirp.sync(path.join(mediaPath, 'reports'));\n\n// const scrub = (string) => string.replace(/\\0/g, '');\n\nexport default class Synchronizer {\n  constructor() {\n    this._tasks = [];\n  }\n\n  addTask(task) {\n    this._tasks.push(task);\n  }\n\n  popTask() {\n    return this._tasks.shift();\n  }\n\n  async run(account, formName, dataSource, {fullSync}) {\n    const start = new Date().getTime();\n\n    const response = await Client.getSync(account);\n\n    this.syncState = fullSync ? [] : JSON.parse(response.body).resources;\n    this.taskParams = { synchronizer: this, syncState: this.syncState };\n\n    this.addTask(new DownloadRoles(this.taskParams));\n    this.addTask(new DownloadMemberships(this.taskParams));\n    this.addTask(new DownloadChoiceLists(this.taskParams));\n    this.addTask(new DownloadClassificationSets(this.taskParams));\n    this.addTask(new DownloadProjects(this.taskParams));\n    this.addTask(new DownloadForms(this.taskParams));\n    this.addTask(new DownloadAllRecords(this.taskParams));\n\n    await dataSource.source.load(account.db);\n\n    do {\n      const task = this.popTask();\n\n      await task.execute({account, dataSource});\n    } while (this._tasks.length);\n\n    console.log('Synced', humanizeDuration(new Date().getTime() - start));\n  }\n}\n"]}