{"version":3,"sources":["../../src/api/client.js"],"names":["reqPromise","promisify","req","options","forever","defaultOptions","headers","baseURL","Client","urlForResource","resource","optionsForRequest","account","result","extend","token","authenticate","userName","password","method","uri","auth","username","sendImmediately","resolve","reject","err","response","body","getSync","url","getForms","getChoiceLists","getClassificationSets","getProjects","ex","console","log","code","connect","getPhotos","form","page","qs","per_page","full","form_id","id","getVideos","download","to","rq","pipe","createWriteStream","on","getRecords","getRecordsHistory","lastSync","updated_since","getTime","client"],"mappings":"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","file":"client.js","sourcesContent":["import request from 'request';\nimport Promise from 'bluebird';\nimport _ from 'lodash';\nimport fs from 'fs';\n\nconst reqPromise = Promise.promisify(request);\nconst req = (options) => reqPromise({forever: true, ...options});\n\nconst defaultOptions = {\n  headers: {\n    'User-Agent': 'Fulcrum Sync',\n    'Accept': 'application/json'\n  }\n};\n\n// const baseURL = 'http://localhost:3000';\n// const baseURL = 'https://api.fulcrumapp.com/api/v2/';\nconst baseURL = 'https://edge.fulcrumapp.com';\n\nclass Client {\n  urlForResource(resource) {\n    return '' + baseURL + resource;\n  }\n\n  optionsForRequest(account, options) {\n    const result = _.extend({}, defaultOptions, options);\n    result.headers['X-ApiToken'] = account.token;\n    return result;\n  }\n\n  async authenticate(userName, password) {\n    const options = {\n      method: 'GET',\n      uri: this.urlForResource('/api/v2/users.json'),\n      auth: {\n        username: userName,\n        password: password,\n        sendImmediately: true\n      },\n      headers: defaultOptions.headers\n    };\n\n    return new Promise((resolve, reject) => {\n      request(options, (err, response, body) => {\n        if (err) {\n          return reject(err);\n        } else {\n          return resolve(response);\n        }\n      });\n    });\n  }\n\n  async getSync(account) {\n    const options = this.optionsForRequest(account, {\n      url: this.urlForResource('/api/_private/sync.json')\n    });\n\n    return await req(options);\n  }\n\n  async getForms(account) {\n    const options = this.optionsForRequest(account, {\n      url: this.urlForResource('/api/v2/forms.json')\n    });\n\n    return await req(options);\n  }\n\n  async getChoiceLists(account) {\n    const options = this.optionsForRequest(account, {\n      url: this.urlForResource('/api/v2/choice_lists.json')\n    });\n\n    return await req(options);\n  }\n\n  async getClassificationSets(account) {\n    const options = this.optionsForRequest(account, {\n      url: this.urlForResource('/api/v2/classification_sets.json')\n    });\n\n    return await req(options);\n  }\n\n  async getProjects(account) {\n    const options = this.optionsForRequest(account, {\n      url: this.urlForResource('/api/v2/projects.json')\n    });\n\n    try {\n      return await req(options);\n    } catch (ex) {\n      console.log(ex);\n      console.log(ex.code === 'ETIMEDOUT');\n      console.log(ex.connect === true);\n      throw ex;\n    }\n  }\n\n  async getPhotos(account, form, page) {\n    const options = this.optionsForRequest(account, {\n      url: this.urlForResource('/api/v2/photos.json')\n    });\n\n    options.qs = {\n      per_page: 1000,\n      page: page,\n      full: '1'\n    };\n\n    if (form) {\n      options.qs.form_id = form.id;\n    }\n\n    return await req(options);\n  }\n\n  async getVideos(account, form, page) {\n    const options = this.optionsForRequest(account, {\n      url: this.urlForResource('/api/v2/videos.json')\n    });\n\n    options.qs = {\n      per_page: 1000,\n      page: page,\n      full: '1'\n    };\n\n    if (form) {\n      options.qs.form_id = form.id;\n    }\n\n    return await req(options);\n  }\n\n  download(url, to) {\n    return new Promise((resolve, reject) => {\n      const rq = request(url).pipe(fs.createWriteStream(to));\n      rq.on('close', resolve);\n      rq.on('error', reject);\n    });\n  }\n\n  async getRecords(account, form, page) {\n    const options = this.optionsForRequest(account, {\n      // url: this.urlForResource('records/history')\n      url: this.urlForResource('/api/v2/records.json')\n    });\n\n    options.qs = {\n      form_id: form.id,\n      per_page: 1000,\n      page: page\n    };\n\n    return await req(options);\n  }\n\n  async getRecordsHistory(account, form, page, lastSync) {\n    const options = this.optionsForRequest(account, {\n      url: this.urlForResource('/api/v2/records/history.json')\n    });\n\n    options.qs = {\n      form_id: form.id,\n      per_page: 1000,\n      page: page,\n      updated_since: lastSync ? lastSync.getTime() / 1000 : 0\n    };\n\n    return await req(options);\n  }\n}\n\nconst client = new Client();\n\nexport default client;\n"]}