{"version":3,"sources":["../src/app.js"],"names":["app","App","instance","constructor","_plugins","_pluginsByName","_listeners","on","name","func","push","off","index","indexOf","splice","emit","args","listener","initialize","db","initializePlugins","runTask","command","_","plugin","yargs","console","error","pluginPaths","sync","join","pluginPath","fullPath","resolve","PluginClass","require","default","nameParts","dirname","split","sep","length","log"],"mappings":"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","file":"app.js","sourcesContent":["import EventEmitter from 'events';\nimport glob from 'glob';\nimport path from 'path';\nimport yargs from 'yargs';\n\nlet app = null;\n\nclass App {\n  static get instance() {\n    return app;\n  }\n\n  constructor() {\n    this._plugins = [];\n    this._pluginsByName = [];\n    this._listeners = {};\n  }\n\n  on(name, func) {\n    if (!this._listeners[name]) {\n      this._listeners[name] = [];\n    }\n\n    this._listeners[name].push(func);\n  }\n\n  off(name, func) {\n    if (this._listeners[name]) {\n      const index = this._listeners.indexOf(func);\n\n      if (index > -1) {\n        this._listeners.splice(index, 1);\n      }\n    }\n  }\n\n  async emit(name, ...args) {\n    if (this._listeners[name]) {\n      for (const listener of this._listeners[name]) {\n        await listener(...args);\n      }\n    }\n  }\n\n  async initialize({db}) {\n    await this.initializePlugins({db});\n  }\n\n  async runTask(command) {\n    const name = command.args._[1];\n\n    const plugin = this._pluginsByName[name];\n\n    if (plugin && plugin.runTask) {\n      await plugin.runTask({app: this, yargs});\n    } else {\n      console.error('Plugin named', name, 'not found');\n    }\n  }\n\n  async initializePlugins({db}) {\n    const pluginPaths = glob.sync(path.join('.', 'plugins', '*', 'plugin.js'));\n\n    for (const pluginPath of pluginPaths) {\n      const fullPath = path.resolve(pluginPath);\n\n      const PluginClass = require(fullPath).default;\n\n      const plugin = new PluginClass({db});\n\n      const nameParts = path.dirname(fullPath).split(path.sep);\n      const name = nameParts[nameParts.length - 1];\n\n      this._pluginsByName[name] = plugin;\n      this._plugins.push(plugin);\n\n      // if (plugin.enabled) {\n        console.log('Loading plugin', fullPath);\n\n        await plugin.initialize({app: this});\n      // }\n    }\n  }\n\n  // emit(name, ...args) {\n  //   this.emit(name, {app: this, ...args[0]});\n  // }\n}\n\napp = new App();\n\nexport default app;\n"]}