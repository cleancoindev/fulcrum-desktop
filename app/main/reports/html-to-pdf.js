'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _uuid = require('uuid');

var _uuid2 = _interopRequireDefault(_uuid);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _child_process = require('child_process');

var _async = require('async');

var _async2 = _interopRequireDefault(_async);

var _rimraf = require('rimraf');

var _rimraf2 = _interopRequireDefault(_rimraf);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_MARGIN = '0.75in';
const DEFAULT_PAGE_SIZE = 'Letter';
const DEFAULT_IMAGE_QUALITY = '85';
const DEFAULT_ORIENTATION = 'Portrait';

class HtmlToPdf {
  constructor(html, { header, footer, cover, marginTop, marginBottom, marginLeft, marginRight, pageSize, imageQuality, orientation, wkhtmltopdf }) {
    this.tempID = _uuid2.default.v4();
    this.debug = false;
    this.html = html;
    this.header = header;
    this.footer = footer;
    this.cover = cover;
    this.wkhtmltopdf = wkhtmltopdf;
    this.marginTop = marginTop || DEFAULT_MARGIN;
    this.marginBottom = marginBottom || DEFAULT_MARGIN;
    this.marginLeft = marginLeft || DEFAULT_MARGIN;
    this.marginRight = marginRight || DEFAULT_MARGIN;
    this.pageSize = pageSize || DEFAULT_PAGE_SIZE;
    this.imageQuality = imageQuality || DEFAULT_IMAGE_QUALITY;
    this.orientation = orientation || DEFAULT_ORIENTATION;
  }

  get binary() {
    return this.wkhtmltopdf || '/usr/local/bin/wkhtmltopdf';
  }

  get command() {
    const parts = ['--page-size', this.pageSize, '--margin-top', this.marginTop, '--margin-left', this.marginLeft, '--margin-bottom', this.marginBottom, '--margin-right', this.marginRight, '--image-quality', this.imageQuality, '--orientation', this.orientation, '--encoding', 'UTF-8', this.quietArgument, ...this.coverArgument, ...this.headerArgument, ...this.footerArgument, this.inputArgument, this.outputArgument];

    return _lodash2.default.compact(parts);
  }

  tempFilePath(part, ext = 'html') {
    return _path2.default.join(_os2.default.tmpdir(), `${this.tempID}_${part}.${ext}`);
  }

  get quietArgument() {
    return '--quiet';
    // return this.debug ? null : '--quiet';
  }

  get inputArgument() {
    return '-';
  }

  get outputArgument() {
    return this.tempFilePath(this.tempID + '_output', 'pdf');
  }

  get coverArgument() {
    if (this.cover) {
      const coverPath = this.tempFilePath('cover');

      _fs2.default.writeFileSync(coverPath, this.cover);

      return ['cover', coverPath];
    }

    return [];
  }

  get headerArgument() {
    if (this.header) {
      const headerPath = this.tempFilePath('header');

      _fs2.default.writeFileSync(headerPath, this.header);

      return ['--header-html', headerPath];
    }

    return [];
  }

  get footerArgument() {
    if (this.footer) {
      const footerPath = this.tempFilePath('footer');

      _fs2.default.writeFileSync(footerPath, this.footer);

      return ['--footer-html', footerPath];
    }

    return [];
  }

  run() {
    return new Promise((resolve, reject) => {
      const cmd = this.command;

      const process = (0, _child_process.spawn)(this.binary, cmd, {});

      const stdout = [];
      const stderr = [];

      process.stdin.setEncoding('utf8');
      process.stdin.end(this.html);

      process.stdout.on('data', data => {
        stdout.push(data.toString());
      });

      process.stderr.on('data', data => {
        stderr.push(data.toString());
      });

      process.on('close', code => {
        _fs2.default.stat(this.outputArgument, (err, stat) => {
          if (err) {
            return reject(err);
          }

          return resolve({ code: code,
            stdout: stdout,
            stderr: stderr,
            size: stat.size,
            file: this.outputArgument });
        });
      });
    });
  }

  cleanup() {
    const files = [this.tempFilePath('header'), this.tempFilePath('cover'), this.tempFilePath('content'), this.tempFilePath('footer'), this.tempFilePath('toc', 'xml'), this.tempFilePath('output', 'pdf')];

    return new Promise((resolve, reject) => {
      _async2.default.each(files, _rimraf2.default, err => {
        if (err) {
          return reject(err);
        } else {
          return resolve();
        }
      });
    });
  }
}
exports.default = HtmlToPdf;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYWluL3JlcG9ydHMvaHRtbC10by1wZGYuanMiXSwibmFtZXMiOlsiREVGQVVMVF9NQVJHSU4iLCJERUZBVUxUX1BBR0VfU0laRSIsIkRFRkFVTFRfSU1BR0VfUVVBTElUWSIsIkRFRkFVTFRfT1JJRU5UQVRJT04iLCJIdG1sVG9QZGYiLCJjb25zdHJ1Y3RvciIsImh0bWwiLCJoZWFkZXIiLCJmb290ZXIiLCJjb3ZlciIsIm1hcmdpblRvcCIsIm1hcmdpbkJvdHRvbSIsIm1hcmdpbkxlZnQiLCJtYXJnaW5SaWdodCIsInBhZ2VTaXplIiwiaW1hZ2VRdWFsaXR5Iiwib3JpZW50YXRpb24iLCJ3a2h0bWx0b3BkZiIsInRlbXBJRCIsInY0IiwiZGVidWciLCJiaW5hcnkiLCJjb21tYW5kIiwicGFydHMiLCJxdWlldEFyZ3VtZW50IiwiY292ZXJBcmd1bWVudCIsImhlYWRlckFyZ3VtZW50IiwiZm9vdGVyQXJndW1lbnQiLCJpbnB1dEFyZ3VtZW50Iiwib3V0cHV0QXJndW1lbnQiLCJjb21wYWN0IiwidGVtcEZpbGVQYXRoIiwicGFydCIsImV4dCIsImpvaW4iLCJ0bXBkaXIiLCJjb3ZlclBhdGgiLCJ3cml0ZUZpbGVTeW5jIiwiaGVhZGVyUGF0aCIsImZvb3RlclBhdGgiLCJydW4iLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImNtZCIsInByb2Nlc3MiLCJzdGRvdXQiLCJzdGRlcnIiLCJzdGRpbiIsInNldEVuY29kaW5nIiwiZW5kIiwib24iLCJkYXRhIiwicHVzaCIsInRvU3RyaW5nIiwiY29kZSIsInN0YXQiLCJlcnIiLCJzaXplIiwiZmlsZSIsImNsZWFudXAiLCJmaWxlcyIsImVhY2giXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQSxNQUFNQSxpQkFBaUIsUUFBdkI7QUFDQSxNQUFNQyxvQkFBb0IsUUFBMUI7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O0FBQzVCLHFCQUFHQyxJQUFILENBQVEsS0FBSzNCLGNBQWIsRUFBNkIsQ0FBQzRCLEdBQUQsRUFBTUQsSUFBTixLQUFlO0FBQzFDLGNBQUlDLEdBQUosRUFBUztBQUNQLG1CQUFPZCxPQUFPYyxHQUFQLENBQVA7QUFDRDs7QUFFRCxpQkFBT2YsUUFBUSxFQUFDYSxNQUFNQSxJQUFQO0FBQ0NULG9CQUFRQSxNQURUO0FBRUNDLG9CQUFRQSxNQUZUO0FBR0NXLGtCQUFNRixLQUFLRSxJQUhaO0FBSUNDLGtCQUFNLEtBQUs5QixjQUpaLEVBQVIsQ0FBUDtBQUtELFNBVkQ7QUFXRCxPQVpEO0FBYUQsS0FoQ00sQ0FBUDtBQWlDRDs7QUFFRCtCLFlBQVU7QUFDUixVQUFNQyxRQUFRLENBQ1osS0FBSzlCLFlBQUwsQ0FBa0IsUUFBbEIsQ0FEWSxFQUVaLEtBQUtBLFlBQUwsQ0FBa0IsT0FBbEIsQ0FGWSxFQUdaLEtBQUtBLFlBQUwsQ0FBa0IsU0FBbEIsQ0FIWSxFQUlaLEtBQUtBLFlBQUwsQ0FBa0IsUUFBbEIsQ0FKWSxFQUtaLEtBQUtBLFlBQUwsQ0FBa0IsS0FBbEIsRUFBeUIsS0FBekIsQ0FMWSxFQU1aLEtBQUtBLFlBQUwsQ0FBa0IsUUFBbEIsRUFBNEIsS0FBNUIsQ0FOWSxDQUFkOztBQVNBLFdBQU8sSUFBSVUsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUN0QyxzQkFBTW1CLElBQU4sQ0FBV0QsS0FBWCxvQkFBMkJKLEdBQUQsSUFBUztBQUNqQyxZQUFJQSxHQUFKLEVBQVM7QUFDUCxpQkFBT2QsT0FBT2MsR0FBUCxDQUFQO0FBQ0QsU0FGRCxNQUVPO0FBQ0wsaUJBQU9mLFNBQVA7QUFDRDtBQUNGLE9BTkQ7QUFPRCxLQVJNLENBQVA7QUFTRDtBQXRKNEI7a0JBQVZ0QyxTIiwiZmlsZSI6Imh0bWwtdG8tcGRmLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHV1aWQgZnJvbSAndXVpZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHNwYXduIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgYXN5bmMgZnJvbSAnYXN5bmMnO1xuaW1wb3J0IHJpbXJhZiBmcm9tICdyaW1yYWYnO1xuXG5jb25zdCBERUZBVUxUX01BUkdJTiA9ICcwLjc1aW4nO1xuY29uc3QgREVGQVVMVF9QQUdFX1NJWkUgPSAnTGV0dGVyJztcbmNvbnN0IERFRkFVTFRfSU1BR0VfUVVBTElUWSA9ICc4NSc7XG5jb25zdCBERUZBVUxUX09SSUVOVEFUSU9OID0gJ1BvcnRyYWl0JztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSHRtbFRvUGRmIHtcbiAgY29uc3RydWN0b3IoaHRtbCwge2hlYWRlciwgZm9vdGVyLCBjb3ZlciwgbWFyZ2luVG9wLCBtYXJnaW5Cb3R0b20sIG1hcmdpbkxlZnQsIG1hcmdpblJpZ2h0LCBwYWdlU2l6ZSwgaW1hZ2VRdWFsaXR5LCBvcmllbnRhdGlvbiwgd2todG1sdG9wZGZ9KSB7XG4gICAgdGhpcy50ZW1wSUQgPSB1dWlkLnY0KCk7XG4gICAgdGhpcy5kZWJ1ZyA9IGZhbHNlO1xuICAgIHRoaXMuaHRtbCA9IGh0bWw7XG4gICAgdGhpcy5oZWFkZXIgPSBoZWFkZXI7XG4gICAgdGhpcy5mb290ZXIgPSBmb290ZXI7XG4gICAgdGhpcy5jb3ZlciA9IGNvdmVyO1xuICAgIHRoaXMud2todG1sdG9wZGYgPSB3a2h0bWx0b3BkZjtcbiAgICB0aGlzLm1hcmdpblRvcCA9IG1hcmdpblRvcCB8fCBERUZBVUxUX01BUkdJTjtcbiAgICB0aGlzLm1hcmdpbkJvdHRvbSA9IG1hcmdpbkJvdHRvbSB8fCBERUZBVUxUX01BUkdJTjtcbiAgICB0aGlzLm1hcmdpbkxlZnQgPSBtYXJnaW5MZWZ0IHx8IERFRkFVTFRfTUFSR0lOO1xuICAgIHRoaXMubWFyZ2luUmlnaHQgPSBtYXJnaW5SaWdodCB8fCBERUZBVUxUX01BUkdJTjtcbiAgICB0aGlzLnBhZ2VTaXplID0gcGFnZVNpemUgfHwgREVGQVVMVF9QQUdFX1NJWkU7XG4gICAgdGhpcy5pbWFnZVF1YWxpdHkgPSBpbWFnZVF1YWxpdHkgfHwgREVGQVVMVF9JTUFHRV9RVUFMSVRZO1xuICAgIHRoaXMub3JpZW50YXRpb24gPSBvcmllbnRhdGlvbiB8fCBERUZBVUxUX09SSUVOVEFUSU9OO1xuICB9XG5cbiAgZ2V0IGJpbmFyeSgpIHtcbiAgICByZXR1cm4gdGhpcy53a2h0bWx0b3BkZiB8fCAnL3Vzci9sb2NhbC9iaW4vd2todG1sdG9wZGYnO1xuICB9XG5cbiAgZ2V0IGNvbW1hbmQoKSB7XG4gICAgY29uc3QgcGFydHMgPSBbXG4gICAgICAnLS1wYWdlLXNpemUnLCB0aGlzLnBhZ2VTaXplLFxuICAgICAgJy0tbWFyZ2luLXRvcCcsIHRoaXMubWFyZ2luVG9wLFxuICAgICAgJy0tbWFyZ2luLWxlZnQnLCB0aGlzLm1hcmdpbkxlZnQsXG4gICAgICAnLS1tYXJnaW4tYm90dG9tJywgdGhpcy5tYXJnaW5Cb3R0b20sXG4gICAgICAnLS1tYXJnaW4tcmlnaHQnLCB0aGlzLm1hcmdpblJpZ2h0LFxuICAgICAgJy0taW1hZ2UtcXVhbGl0eScsIHRoaXMuaW1hZ2VRdWFsaXR5LFxuICAgICAgJy0tb3JpZW50YXRpb24nLCB0aGlzLm9yaWVudGF0aW9uLFxuICAgICAgJy0tZW5jb2RpbmcnLCAnVVRGLTgnLFxuICAgICAgdGhpcy5xdWlldEFyZ3VtZW50LFxuICAgICAgLi4udGhpcy5jb3ZlckFyZ3VtZW50LFxuICAgICAgLi4udGhpcy5oZWFkZXJBcmd1bWVudCxcbiAgICAgIC4uLnRoaXMuZm9vdGVyQXJndW1lbnQsXG4gICAgICB0aGlzLmlucHV0QXJndW1lbnQsXG4gICAgICB0aGlzLm91dHB1dEFyZ3VtZW50IF07XG5cbiAgICByZXR1cm4gXy5jb21wYWN0KHBhcnRzKTtcbiAgfVxuXG4gIHRlbXBGaWxlUGF0aChwYXJ0LCBleHQgPSAnaHRtbCcpIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKG9zLnRtcGRpcigpLCBgJHt0aGlzLnRlbXBJRH1fJHtwYXJ0fS4ke2V4dH1gKTtcbiAgfVxuXG4gIGdldCBxdWlldEFyZ3VtZW50KCkge1xuICAgIHJldHVybiAnLS1xdWlldCc7XG4gICAgLy8gcmV0dXJuIHRoaXMuZGVidWcgPyBudWxsIDogJy0tcXVpZXQnO1xuICB9XG5cbiAgZ2V0IGlucHV0QXJndW1lbnQoKSB7XG4gICAgcmV0dXJuICctJztcbiAgfVxuXG4gIGdldCBvdXRwdXRBcmd1bWVudCgpIHtcbiAgICByZXR1cm4gdGhpcy50ZW1wRmlsZVBhdGgodGhpcy50ZW1wSUQgKyAnX291dHB1dCcsICdwZGYnKTtcbiAgfVxuXG4gIGdldCBjb3ZlckFyZ3VtZW50KCkge1xuICAgIGlmICh0aGlzLmNvdmVyKSB7XG4gICAgICBjb25zdCBjb3ZlclBhdGggPSB0aGlzLnRlbXBGaWxlUGF0aCgnY292ZXInKTtcblxuICAgICAgZnMud3JpdGVGaWxlU3luYyhjb3ZlclBhdGgsIHRoaXMuY292ZXIpO1xuXG4gICAgICByZXR1cm4gWyAnY292ZXInLCBjb3ZlclBhdGggXTtcbiAgICB9XG5cbiAgICByZXR1cm4gW107XG4gIH1cblxuICBnZXQgaGVhZGVyQXJndW1lbnQoKSB7XG4gICAgaWYgKHRoaXMuaGVhZGVyKSB7XG4gICAgICBjb25zdCBoZWFkZXJQYXRoID0gdGhpcy50ZW1wRmlsZVBhdGgoJ2hlYWRlcicpO1xuXG4gICAgICBmcy53cml0ZUZpbGVTeW5jKGhlYWRlclBhdGgsIHRoaXMuaGVhZGVyKTtcblxuICAgICAgcmV0dXJuIFsgJy0taGVhZGVyLWh0bWwnLCBoZWFkZXJQYXRoIF07XG4gICAgfVxuXG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgZ2V0IGZvb3RlckFyZ3VtZW50KCkge1xuICAgIGlmICh0aGlzLmZvb3Rlcikge1xuICAgICAgY29uc3QgZm9vdGVyUGF0aCA9IHRoaXMudGVtcEZpbGVQYXRoKCdmb290ZXInKTtcblxuICAgICAgZnMud3JpdGVGaWxlU3luYyhmb290ZXJQYXRoLCB0aGlzLmZvb3Rlcik7XG5cbiAgICAgIHJldHVybiBbICctLWZvb3Rlci1odG1sJywgZm9vdGVyUGF0aCBdO1xuICAgIH1cblxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHJ1bigpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgY21kID0gdGhpcy5jb21tYW5kO1xuXG4gICAgICBjb25zdCBwcm9jZXNzID0gc3Bhd24odGhpcy5iaW5hcnksIGNtZCwge30pO1xuXG4gICAgICBjb25zdCBzdGRvdXQgPSBbXTtcbiAgICAgIGNvbnN0IHN0ZGVyciA9IFtdO1xuXG4gICAgICBwcm9jZXNzLnN0ZGluLnNldEVuY29kaW5nKCd1dGY4Jyk7XG4gICAgICBwcm9jZXNzLnN0ZGluLmVuZCh0aGlzLmh0bWwpO1xuXG4gICAgICBwcm9jZXNzLnN0ZG91dC5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgIHN0ZG91dC5wdXNoKGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICB9KTtcblxuICAgICAgcHJvY2Vzcy5zdGRlcnIub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgICBzdGRlcnIucHVzaChkYXRhLnRvU3RyaW5nKCkpO1xuICAgICAgfSk7XG5cbiAgICAgIHByb2Nlc3Mub24oJ2Nsb3NlJywgKGNvZGUpID0+IHtcbiAgICAgICAgZnMuc3RhdCh0aGlzLm91dHB1dEFyZ3VtZW50LCAoZXJyLCBzdGF0KSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiByZXNvbHZlKHtjb2RlOiBjb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQ6IHN0ZG91dCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RkZXJyOiBzdGRlcnIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU6IHN0YXQuc2l6ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZTogdGhpcy5vdXRwdXRBcmd1bWVudH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgY2xlYW51cCgpIHtcbiAgICBjb25zdCBmaWxlcyA9IFtcbiAgICAgIHRoaXMudGVtcEZpbGVQYXRoKCdoZWFkZXInKSxcbiAgICAgIHRoaXMudGVtcEZpbGVQYXRoKCdjb3ZlcicpLFxuICAgICAgdGhpcy50ZW1wRmlsZVBhdGgoJ2NvbnRlbnQnKSxcbiAgICAgIHRoaXMudGVtcEZpbGVQYXRoKCdmb290ZXInKSxcbiAgICAgIHRoaXMudGVtcEZpbGVQYXRoKCd0b2MnLCAneG1sJyksXG4gICAgICB0aGlzLnRlbXBGaWxlUGF0aCgnb3V0cHV0JywgJ3BkZicpXG4gICAgXTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBhc3luYy5lYWNoKGZpbGVzLCByaW1yYWYsIChlcnIpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuIl19