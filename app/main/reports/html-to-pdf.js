'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _uuid = require('uuid');

var _uuid2 = _interopRequireDefault(_uuid);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _child_process = require('child_process');

var _async = require('async');

var _async2 = _interopRequireDefault(_async);

var _rimraf = require('rimraf');

var _rimraf2 = _interopRequireDefault(_rimraf);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_MARGIN = '0.75in';
const DEFAULT_PAGE_SIZE = 'Letter';
const DEFAULT_IMAGE_QUALITY = '85';
const DEFAULT_ORIENTATION = 'Portrait';

class HtmlToPdf {
  constructor(html, { header, footer, cover, marginTop, marginBottom, marginLeft, marginRight, pageSize, imageQuality, orientation }) {
    this.tempID = _uuid2.default.v4();
    this.debug = false;
    this.html = html;
    this.header = header;
    this.footer = footer;
    this.cover = cover;
    this.marginTop = marginTop || DEFAULT_MARGIN;
    this.marginBottom = marginBottom || DEFAULT_MARGIN;
    this.marginLeft = marginLeft || DEFAULT_MARGIN;
    this.marginRight = marginRight || DEFAULT_MARGIN;
    this.pageSize = pageSize || DEFAULT_PAGE_SIZE;
    this.imageQuality = imageQuality || DEFAULT_IMAGE_QUALITY;
    this.orientation = orientation || DEFAULT_ORIENTATION;
  }

  get binary() {
    return '/usr/local/bin/wkhtmltopdf';
  }

  get command() {
    const parts = ['--page-size', this.pageSize, '--margin-top', this.marginTop, '--margin-left', this.marginLeft, '--margin-bottom', this.marginBottom, '--margin-right', this.marginRight, '--image-quality', this.imageQuality, '--orientation', this.orientation, '--encoding', 'UTF-8', this.quietArgument, ...this.coverArgument, ...this.headerArgument, ...this.footerArgument, this.inputArgument, this.outputArgument];

    return _lodash2.default.compact(parts);
  }

  tempFilePath(part, ext = 'html') {
    return _path2.default.join(_os2.default.tmpdir(), `${this.tempID}_${part}.${ext}`);
  }

  get quietArgument() {
    return '--quiet';
    // return this.debug ? null : '--quiet';
  }

  get inputArgument() {
    return '-';
  }

  get outputArgument() {
    return this.tempFilePath(this.tempID + '_output', 'pdf');
  }

  get coverArgument() {
    if (this.cover) {
      const coverPath = this.tempFilePath('cover');

      _fs2.default.writeFileSync(coverPath, this.cover);

      return ['cover', coverPath];
    }

    return [];
  }

  get headerArgument() {
    if (this.header) {
      const headerPath = this.tempFilePath('header');

      _fs2.default.writeFileSync(headerPath, this.header);

      return ['--header-html', headerPath];
    }

    return [];
  }

  get footerArgument() {
    if (this.footer) {
      const footerPath = this.tempFilePath('footer');

      _fs2.default.writeFileSync(footerPath, this.footer);

      return ['--footer-html', footerPath];
    }

    return [];
  }

  run() {
    return new Promise((resolve, reject) => {
      const cmd = this.command;

      const process = (0, _child_process.spawn)(this.binary, cmd, {});

      const stdout = [];
      const stderr = [];

      process.stdin.setEncoding('utf8');
      process.stdin.end(this.html);

      process.stdout.on('data', data => {
        stdout.push(data.toString());
      });

      process.stderr.on('data', data => {
        stderr.push(data.toString());
      });

      process.on('close', code => {
        _fs2.default.stat(this.outputArgument, (err, stat) => {
          if (err) {
            return reject(err);
          }

          return resolve({ code: code,
            stdout: stdout,
            stderr: stderr,
            size: stat.size,
            file: this.outputArgument });
        });
      });
    });
  }

  cleanup() {
    const files = [this.tempFilePath('header'), this.tempFilePath('cover'), this.tempFilePath('content'), this.tempFilePath('footer'), this.tempFilePath('toc', 'xml'), this.tempFilePath('output', 'pdf')];

    return new Promise((resolve, reject) => {
      _async2.default.each(files, _rimraf2.default, err => {
        if (err) {
          return reject(err);
        } else {
          return resolve();
        }
      });
    });
  }
}
exports.default = HtmlToPdf;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYWluL3JlcG9ydHMvaHRtbC10by1wZGYuanMiXSwibmFtZXMiOlsiREVGQVVMVF9NQVJHSU4iLCJERUZBVUxUX1BBR0VfU0laRSIsIkRFRkFVTFRfSU1BR0VfUVVBTElUWSIsIkRFRkFVTFRfT1JJRU5UQVRJT04iLCJIdG1sVG9QZGYiLCJjb25zdHJ1Y3RvciIsImh0bWwiLCJoZWFkZXIiLCJmb290ZXIiLCJjb3ZlciIsIm1hcmdpblRvcCIsIm1hcmdpbkJvdHRvbSIsIm1hcmdpbkxlZnQiLCJtYXJnaW5SaWdodCIsInBhZ2VTaXplIiwiaW1hZ2VRdWFsaXR5Iiwib3JpZW50YXRpb24iLCJ0ZW1wSUQiLCJ2NCIsImRlYnVnIiwiYmluYXJ5IiwiY29tbWFuZCIsInBhcnRzIiwicXVpZXRBcmd1bWVudCIsImNvdmVyQXJndW1lbnQiLCJoZWFkZXJBcmd1bWVudCIsImZvb3RlckFyZ3VtZW50IiwiaW5wdXRBcmd1bWVudCIsIm91dHB1dEFyZ3VtZW50IiwiY29tcGFjdCIsInRlbXBGaWxlUGF0aCIsInBhcnQiLCJleHQiLCJqb2luIiwidG1wZGlyIiwiY292ZXJQYXRoIiwid3JpdGVGaWxlU3luYyIsImhlYWRlclBhdGgiLCJmb290ZXJQYXRoIiwicnVuIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJjbWQiLCJwcm9jZXNzIiwic3Rkb3V0Iiwic3RkZXJyIiwic3RkaW4iLCJzZXRFbmNvZGluZyIsImVuZCIsIm9uIiwiZGF0YSIsInB1c2giLCJ0b1N0cmluZyIsImNvZGUiLCJzdGF0IiwiZXJyIiwic2l6ZSIsImZpbGUiLCJjbGVhbnVwIiwiZmlsZXMiLCJlYWNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsaUJBQWlCLFFBQXZCO0FBQ0EsTUFBTUMsb0JBQW9CLFFBQTFCO0FBQ0EsTUFBTUMsd0JB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LGNBQUlDLEdBQUosRUFBUztBQUNQLG1CQUFPZCxPQUFPYyxHQUFQLENBQVA7QUFDRDs7QUFFRCxpQkFBT2YsUUFBUSxFQUFDYSxNQUFNQSxJQUFQO0FBQ0NULG9CQUFRQSxNQURUO0FBRUNDLG9CQUFRQSxNQUZUO0FBR0NXLGtCQUFNRixLQUFLRSxJQUhaO0FBSUNDLGtCQUFNLEtBQUs5QixjQUpaLEVBQVIsQ0FBUDtBQUtELFNBVkQ7QUFXRCxPQVpEO0FBYUQsS0FoQ00sQ0FBUDtBQWlDRDs7QUFFRCtCLFlBQVU7QUFDUixVQUFNQyxRQUFRLENBQ1osS0FBSzlCLFlBQUwsQ0FBa0IsUUFBbEIsQ0FEWSxFQUVaLEtBQUtBLFlBQUwsQ0FBa0IsT0FBbEIsQ0FGWSxFQUdaLEtBQUtBLFlBQUwsQ0FBa0IsU0FBbEIsQ0FIWSxFQUlaLEtBQUtBLFlBQUwsQ0FBa0IsUUFBbEIsQ0FKWSxFQUtaLEtBQUtBLFlBQUwsQ0FBa0IsS0FBbEIsRUFBeUIsS0FBekIsQ0FMWSxFQU1aLEtBQUtBLFlBQUwsQ0FBa0IsUUFBbEIsRUFBNEIsS0FBNUIsQ0FOWSxDQUFkOztBQVNBLFdBQU8sSUFBSVUsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUN0QyxzQkFBTW1CLElBQU4sQ0FBV0QsS0FBWCxvQkFBMkJKLEdBQUQsSUFBUztBQUNqQyxZQUFJQSxHQUFKLEVBQVM7QUFDUCxpQkFBT2QsT0FBT2MsR0FBUCxDQUFQO0FBQ0QsU0FGRCxNQUVPO0FBQ0wsaUJBQU9mLFNBQVA7QUFDRDtBQUNGLE9BTkQ7QUFPRCxLQVJNLENBQVA7QUFTRDtBQXJKNEI7a0JBQVZyQyxTIiwiZmlsZSI6Imh0bWwtdG8tcGRmLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHV1aWQgZnJvbSAndXVpZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHNwYXduIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgYXN5bmMgZnJvbSAnYXN5bmMnO1xuaW1wb3J0IHJpbXJhZiBmcm9tICdyaW1yYWYnO1xuXG5jb25zdCBERUZBVUxUX01BUkdJTiA9ICcwLjc1aW4nO1xuY29uc3QgREVGQVVMVF9QQUdFX1NJWkUgPSAnTGV0dGVyJztcbmNvbnN0IERFRkFVTFRfSU1BR0VfUVVBTElUWSA9ICc4NSc7XG5jb25zdCBERUZBVUxUX09SSUVOVEFUSU9OID0gJ1BvcnRyYWl0JztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSHRtbFRvUGRmIHtcbiAgY29uc3RydWN0b3IoaHRtbCwge2hlYWRlciwgZm9vdGVyLCBjb3ZlciwgbWFyZ2luVG9wLCBtYXJnaW5Cb3R0b20sIG1hcmdpbkxlZnQsIG1hcmdpblJpZ2h0LCBwYWdlU2l6ZSwgaW1hZ2VRdWFsaXR5LCBvcmllbnRhdGlvbn0pIHtcbiAgICB0aGlzLnRlbXBJRCA9IHV1aWQudjQoKTtcbiAgICB0aGlzLmRlYnVnID0gZmFsc2U7XG4gICAgdGhpcy5odG1sID0gaHRtbDtcbiAgICB0aGlzLmhlYWRlciA9IGhlYWRlcjtcbiAgICB0aGlzLmZvb3RlciA9IGZvb3RlcjtcbiAgICB0aGlzLmNvdmVyID0gY292ZXI7XG4gICAgdGhpcy5tYXJnaW5Ub3AgPSBtYXJnaW5Ub3AgfHwgREVGQVVMVF9NQVJHSU47XG4gICAgdGhpcy5tYXJnaW5Cb3R0b20gPSBtYXJnaW5Cb3R0b20gfHwgREVGQVVMVF9NQVJHSU47XG4gICAgdGhpcy5tYXJnaW5MZWZ0ID0gbWFyZ2luTGVmdCB8fCBERUZBVUxUX01BUkdJTjtcbiAgICB0aGlzLm1hcmdpblJpZ2h0ID0gbWFyZ2luUmlnaHQgfHwgREVGQVVMVF9NQVJHSU47XG4gICAgdGhpcy5wYWdlU2l6ZSA9IHBhZ2VTaXplIHx8IERFRkFVTFRfUEFHRV9TSVpFO1xuICAgIHRoaXMuaW1hZ2VRdWFsaXR5ID0gaW1hZ2VRdWFsaXR5IHx8IERFRkFVTFRfSU1BR0VfUVVBTElUWTtcbiAgICB0aGlzLm9yaWVudGF0aW9uID0gb3JpZW50YXRpb24gfHwgREVGQVVMVF9PUklFTlRBVElPTjtcbiAgfVxuXG4gIGdldCBiaW5hcnkoKSB7XG4gICAgcmV0dXJuICcvdXNyL2xvY2FsL2Jpbi93a2h0bWx0b3BkZic7XG4gIH1cblxuICBnZXQgY29tbWFuZCgpIHtcbiAgICBjb25zdCBwYXJ0cyA9IFtcbiAgICAgICctLXBhZ2Utc2l6ZScsIHRoaXMucGFnZVNpemUsXG4gICAgICAnLS1tYXJnaW4tdG9wJywgdGhpcy5tYXJnaW5Ub3AsXG4gICAgICAnLS1tYXJnaW4tbGVmdCcsIHRoaXMubWFyZ2luTGVmdCxcbiAgICAgICctLW1hcmdpbi1ib3R0b20nLCB0aGlzLm1hcmdpbkJvdHRvbSxcbiAgICAgICctLW1hcmdpbi1yaWdodCcsIHRoaXMubWFyZ2luUmlnaHQsXG4gICAgICAnLS1pbWFnZS1xdWFsaXR5JywgdGhpcy5pbWFnZVF1YWxpdHksXG4gICAgICAnLS1vcmllbnRhdGlvbicsIHRoaXMub3JpZW50YXRpb24sXG4gICAgICAnLS1lbmNvZGluZycsICdVVEYtOCcsXG4gICAgICB0aGlzLnF1aWV0QXJndW1lbnQsXG4gICAgICAuLi50aGlzLmNvdmVyQXJndW1lbnQsXG4gICAgICAuLi50aGlzLmhlYWRlckFyZ3VtZW50LFxuICAgICAgLi4udGhpcy5mb290ZXJBcmd1bWVudCxcbiAgICAgIHRoaXMuaW5wdXRBcmd1bWVudCxcbiAgICAgIHRoaXMub3V0cHV0QXJndW1lbnQgXTtcblxuICAgIHJldHVybiBfLmNvbXBhY3QocGFydHMpO1xuICB9XG5cbiAgdGVtcEZpbGVQYXRoKHBhcnQsIGV4dCA9ICdodG1sJykge1xuICAgIHJldHVybiBwYXRoLmpvaW4ob3MudG1wZGlyKCksIGAke3RoaXMudGVtcElEfV8ke3BhcnR9LiR7ZXh0fWApO1xuICB9XG5cbiAgZ2V0IHF1aWV0QXJndW1lbnQoKSB7XG4gICAgcmV0dXJuICctLXF1aWV0JztcbiAgICAvLyByZXR1cm4gdGhpcy5kZWJ1ZyA/IG51bGwgOiAnLS1xdWlldCc7XG4gIH1cblxuICBnZXQgaW5wdXRBcmd1bWVudCgpIHtcbiAgICByZXR1cm4gJy0nO1xuICB9XG5cbiAgZ2V0IG91dHB1dEFyZ3VtZW50KCkge1xuICAgIHJldHVybiB0aGlzLnRlbXBGaWxlUGF0aCh0aGlzLnRlbXBJRCArICdfb3V0cHV0JywgJ3BkZicpO1xuICB9XG5cbiAgZ2V0IGNvdmVyQXJndW1lbnQoKSB7XG4gICAgaWYgKHRoaXMuY292ZXIpIHtcbiAgICAgIGNvbnN0IGNvdmVyUGF0aCA9IHRoaXMudGVtcEZpbGVQYXRoKCdjb3ZlcicpO1xuXG4gICAgICBmcy53cml0ZUZpbGVTeW5jKGNvdmVyUGF0aCwgdGhpcy5jb3Zlcik7XG5cbiAgICAgIHJldHVybiBbICdjb3ZlcicsIGNvdmVyUGF0aCBdO1xuICAgIH1cblxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGdldCBoZWFkZXJBcmd1bWVudCgpIHtcbiAgICBpZiAodGhpcy5oZWFkZXIpIHtcbiAgICAgIGNvbnN0IGhlYWRlclBhdGggPSB0aGlzLnRlbXBGaWxlUGF0aCgnaGVhZGVyJyk7XG5cbiAgICAgIGZzLndyaXRlRmlsZVN5bmMoaGVhZGVyUGF0aCwgdGhpcy5oZWFkZXIpO1xuXG4gICAgICByZXR1cm4gWyAnLS1oZWFkZXItaHRtbCcsIGhlYWRlclBhdGggXTtcbiAgICB9XG5cbiAgICByZXR1cm4gW107XG4gIH1cblxuICBnZXQgZm9vdGVyQXJndW1lbnQoKSB7XG4gICAgaWYgKHRoaXMuZm9vdGVyKSB7XG4gICAgICBjb25zdCBmb290ZXJQYXRoID0gdGhpcy50ZW1wRmlsZVBhdGgoJ2Zvb3RlcicpO1xuXG4gICAgICBmcy53cml0ZUZpbGVTeW5jKGZvb3RlclBhdGgsIHRoaXMuZm9vdGVyKTtcblxuICAgICAgcmV0dXJuIFsgJy0tZm9vdGVyLWh0bWwnLCBmb290ZXJQYXRoIF07XG4gICAgfVxuXG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgcnVuKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBjbWQgPSB0aGlzLmNvbW1hbmQ7XG5cbiAgICAgIGNvbnN0IHByb2Nlc3MgPSBzcGF3bih0aGlzLmJpbmFyeSwgY21kLCB7fSk7XG5cbiAgICAgIGNvbnN0IHN0ZG91dCA9IFtdO1xuICAgICAgY29uc3Qgc3RkZXJyID0gW107XG5cbiAgICAgIHByb2Nlc3Muc3RkaW4uc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICAgIHByb2Nlc3Muc3RkaW4uZW5kKHRoaXMuaHRtbCk7XG5cbiAgICAgIHByb2Nlc3Muc3Rkb3V0Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgc3Rkb3V0LnB1c2goZGF0YS50b1N0cmluZygpKTtcbiAgICAgIH0pO1xuXG4gICAgICBwcm9jZXNzLnN0ZGVyci5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgIHN0ZGVyci5wdXNoKGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICB9KTtcblxuICAgICAgcHJvY2Vzcy5vbignY2xvc2UnLCAoY29kZSkgPT4ge1xuICAgICAgICBmcy5zdGF0KHRoaXMub3V0cHV0QXJndW1lbnQsIChlcnIsIHN0YXQpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUoe2NvZGU6IGNvZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHN0ZG91dDogc3Rkb3V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRlcnI6IHN0ZGVycixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZTogc3RhdC5zaXplLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlOiB0aGlzLm91dHB1dEFyZ3VtZW50fSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBjbGVhbnVwKCkge1xuICAgIGNvbnN0IGZpbGVzID0gW1xuICAgICAgdGhpcy50ZW1wRmlsZVBhdGgoJ2hlYWRlcicpLFxuICAgICAgdGhpcy50ZW1wRmlsZVBhdGgoJ2NvdmVyJyksXG4gICAgICB0aGlzLnRlbXBGaWxlUGF0aCgnY29udGVudCcpLFxuICAgICAgdGhpcy50ZW1wRmlsZVBhdGgoJ2Zvb3RlcicpLFxuICAgICAgdGhpcy50ZW1wRmlsZVBhdGgoJ3RvYycsICd4bWwnKSxcbiAgICAgIHRoaXMudGVtcEZpbGVQYXRoKCdvdXRwdXQnLCAncGRmJylcbiAgICBdO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGFzeW5jLmVhY2goZmlsZXMsIHJpbXJhZiwgKGVycikgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiByZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG59XG4iXX0=