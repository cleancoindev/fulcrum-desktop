{"version":3,"sources":["../../../../src/main/models/record-values/record-values.js"],"names":["RecordValues","updateForRecordStatements","db","record","statements","push","apply","deleteForRecordStatements","form","insertForRecordStatements","insertRowForFeatureStatement","insertChildFeaturesForFeatureStatements","insertMultipleValuesForFeatureStatements","insertChildMultipleValuesForFeatureStatements","feature","parentFeature","values","columnValuesForFeature","systemValues","systemColumnValuesForFeature","Object","assign","tableName","tableNameWithForm","_element","insertStatement","pk","formValue","formValues","all","element","isRepeatableElement","repeatableItem","_items","isEmpty","columnValue","isNumber","isString","isArray","isDate","getFullYear","key","toLowerCase","multipleValuesForFeature","multipleValueTableNameWithForm","parentResourceId","id","multipleValueItem","insertValues","text_value","value","record_id","rowID","record_resource_id","parent_resource_id","featureValues","multipleValues","_projectRowID","project_id","projectID","project_resource_id","_assignedToRowID","assigned_to_id","assignedToID","assigned_to_resource_id","_createdByRowID","created_by_id","createdByID","created_by_resource_id","_updatedByRowID","updated_by_id","updatedByID","updated_by_resource_id","_changesetRowID","changeset_id","changesetID","changeset_resource_id","status","latitude","longitude","altitude","speed","course","vertical_accuracy","verticalAccuracy","horizontal_accuracy","horizontalAccuracy","resource_id","index","hasCoordinate","record_status","record_project_id","record_project_resource_id","record_assigned_to_id","record_assigned_to_resource_id","createdBy","updatedBy","changeset","title","displayValue","form_values","JSON","stringify","toJSON","setupSearch","geometry","setupPoint","created_at","clientCreatedAt","createdAt","updated_at","clientUpdatedAt","updatedAt","version","server_created_at","server_updated_at","created_duration","createdDuration","updated_duration","updatedDuration","edited_duration","editedDuration","created_latitude","createdLatitude","created_longitude","createdLongitude","created_altitude","createdAltitude","created_horizontal_accuracy","createdAccuracy","hasCreatedCoordinate","created_geometry","updated_latitude","updatedLatitude","updated_longitude","updatedLongitude","updated_altitude","updatedAltitude","updated_horizontal_accuracy","updatedAccuracy","hasUpdatedCoordinate","updated_geometry","deleteRowsForRecordStatement","deleteStatement","deleteRowsStatement","repeatables","elementsOfType","repeatable","deleteForFormStatements","_accountRowID","searchableValue","record_index_text","record_index","raw","wkt"],"mappings":"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","file":"record-values.js","sourcesContent":["import { format } from 'util';\nimport _ from 'lodash';\nimport { Record, RepeatableItemValue } from 'fulcrum-core';\nimport pgformat from 'pg-format';\n\nexport default class RecordValues {\n  static updateForRecordStatements(db, record) {\n    const statements = [];\n\n    statements.push.apply(statements, this.deleteForRecordStatements(db, record, record.form));\n    statements.push.apply(statements, this.insertForRecordStatements(db, record, record.form));\n\n    return statements;\n  }\n\n  static insertForRecordStatements(db, record, form) {\n    const statements = [];\n\n    statements.push(this.insertRowForFeatureStatement(db, form, record, null, record));\n    statements.push.apply(statements, this.insertChildFeaturesForFeatureStatements(db, form, record, record));\n    statements.push.apply(statements, this.insertMultipleValuesForFeatureStatements(db, form, record, record));\n    statements.push.apply(statements, this.insertChildMultipleValuesForFeatureStatements(db, form, record, record));\n\n    return statements;\n  }\n\n  static insertRowForFeatureStatement(db, form, feature, parentFeature, record) {\n    const values = this.columnValuesForFeature(feature);\n    const systemValues = this.systemColumnValuesForFeature(feature, parentFeature, record);\n\n    Object.assign(values, systemValues);\n\n    let tableName = null;\n\n    if (feature instanceof RepeatableItemValue) {\n      // TODO(zhm) add public interface for accessing _element, like `get repeatableElement()`\n      tableName = this.tableNameWithForm(form, feature._element);\n    } else {\n      tableName = this.tableNameWithForm(form, null);\n    }\n\n    return db.insertStatement(tableName, values, {pk: 'id'});\n  }\n\n  static insertChildFeaturesForFeatureStatements(db, form, feature, record) {\n    const statements = [];\n\n    for (const formValue of feature.formValues.all) {\n      if (formValue.element.isRepeatableElement) {\n        // TODO(zhm) add public interface for _items\n        for (const repeatableItem of formValue._items) {\n          statements.push(this.insertRowForFeatureStatement(db, form, repeatableItem, feature, record));\n          statements.push.apply(statements, this.insertChildFeaturesForFeatureStatements(db, form, repeatableItem, record));\n        }\n      }\n    }\n\n    return statements;\n  }\n\n  static columnValuesForFeature(feature) {\n    const values = {};\n\n    for (const formValue of feature.formValues.all) {\n      if (formValue.isEmpty) {\n        continue;\n      }\n\n      let columnValue = formValue.columnValue;\n\n      if (_.isNumber(columnValue) || _.isString(columnValue) || _.isArray(columnValue) || _.isDate(columnValue)) {\n        // don't allow dates greater than 9999, yes - they exist in the wild\n        if (_.isDate(columnValue) && columnValue.getFullYear() > 9999) {\n          columnValue = null;\n        }\n\n        values['f' + formValue.element.key.toLowerCase()] = columnValue;\n      } else if (columnValue) {\n        Object.assign(values, columnValue);\n      }\n    }\n\n    return values;\n  }\n\n  static insertMultipleValuesForFeatureStatements(db, form, feature, record) {\n    const statements = [];\n\n    const values = this.multipleValuesForFeature(feature, record);\n\n    const tableName = this.multipleValueTableNameWithForm(form);\n\n    let parentResourceId = null;\n\n    if (feature instanceof RepeatableItemValue) {\n      parentResourceId = feature.id;\n    }\n\n    for (const multipleValueItem of values) {\n      const insertValues = Object.assign({}, {key: multipleValueItem.element.key, text_value: multipleValueItem.value},\n                                         {record_id: record.rowID, record_resource_id: record.id, parent_resource_id: parentResourceId});\n\n      statements.push(db.insertStatement(tableName, insertValues, {pk: 'id'}));\n    }\n\n    return statements;\n  }\n\n  static insertChildMultipleValuesForFeatureStatements(db, form, feature, record) {\n    const statements = [];\n\n    for (const formValue of feature.formValues.all) {\n      if (formValue.isRepeatableElement) {\n        for (const repeatableItem of formValue._items) {\n          statements.push.apply(statements, this.insertMultipleValuesForFeatureStatements(db, form, repeatableItem, record));\n          statements.push.apply(statements, this.insertChildMultipleValuesForFeatureStatements(db, form, repeatableItem, record));\n        }\n      }\n    }\n\n    return statements;\n  }\n\n  static multipleValuesForFeature(feature, record) {\n    const values = [];\n\n    for (const formValue of feature.formValues.all) {\n      if (formValue.isEmpty) {\n        continue;\n      }\n\n      const featureValues = formValue.multipleValues;\n\n      if (featureValues) {\n        values.push.apply(values, featureValues);\n      }\n    }\n\n    return values;\n  }\n\n  static systemColumnValuesForFeature(feature, parentFeature, record) {\n    const values = {};\n\n    values.record_id = record.rowID;\n    values.record_resource_id = record.id;\n\n    if (feature instanceof Record) {\n      if (record._projectRowID) {\n        values.project_id = record._projectRowID;\n      }\n\n      if (record.projectID) {\n        values.project_resource_id = record.projectID;\n      }\n\n      if (record._assignedToRowID) {\n        values.assigned_to_id = record._assignedToRowID;\n      }\n\n      if (record.assignedToID) {\n        values.assigned_to_resource_id = record.assignedToID;\n      }\n\n      if (record._createdByRowID) {\n        values.created_by_id = record._createdByRowID;\n      }\n\n      if (record.createdByID) {\n        values.created_by_resource_id = record.createdByID;\n      }\n\n      if (record._updatedByRowID) {\n        values.updated_by_id = record._updatedByRowID;\n      }\n\n      if (record.updatedByID) {\n        values.updated_by_resource_id = record.updatedByID;\n      }\n\n      if (record._changesetRowID) {\n        values.changeset_id = record._changesetRowID;\n      }\n\n      if (record.changesetID) {\n        values.changeset_resource_id = record.changesetID;\n      }\n\n      if (record.status) {\n        values.status = record.status;\n      }\n\n      if (record.latitude != null) {\n        values.latitude = record.latitude;\n      }\n\n      if (record.longitude != null) {\n        values.longitude = record.longitude;\n      }\n\n      values.altitude = record.altitude;\n      values.speed = record.speed;\n      values.course = record.course;\n      values.vertical_accuracy = record.verticalAccuracy;\n      values.horizontal_accuracy = record.horizontalAccuracy;\n    } else if (feature instanceof RepeatableItemValue) {\n      values.resource_id = feature.id;\n      values.index = feature.index;\n      values.parent_resource_id = parentFeature.id;\n\n      if (feature.hasCoordinate) {\n        values.latitude = feature.latitude;\n        values.longitude = feature.longitude;\n      }\n\n      // record values\n      if (record.status) {\n        values.record_status = record.status;\n      }\n\n      if (record._projectRowID) {\n        values.record_project_id = record._projectRowID;\n      }\n\n      if (record.projectID) {\n        values.record_project_resource_id = record.projectID;\n      }\n\n      if (record._assignedToRowID) {\n        values.record_assigned_to_id = record._assignedToRowID;\n      }\n\n      if (record.assignedToID) {\n        values.record_assigned_to_resource_id = record.assignedToID;\n      }\n\n      // linked fields\n      if (feature.createdBy) {\n        values.created_by_id = feature.createdBy.rowID;\n      }\n\n      if (feature.createdByID) {\n        values.created_by_resource_id = feature.createdByID;\n      }\n\n      if (feature.updatedBy) {\n        values.updated_by_id = feature.updatedBy.rowID;\n      }\n\n      if (feature.updatedByID) {\n        values.updated_by_resource_id = feature.updatedByID;\n      }\n\n      if (feature.changeset) {\n        values.changeset_id = feature.changeset.rowID;\n        values.changeset_resource_id = feature.changesetID;\n      } else if (record._changesetRowID) {\n        values.changeset_id = record._changesetRowID;\n        values.changeset_resource_id = record.changesetID;\n      }\n    }\n\n    values.title = feature.displayValue;\n\n    values.form_values = JSON.stringify(feature.formValues.toJSON());\n\n    this.setupSearch(values, feature);\n\n    if (feature.hasCoordinate) {\n      values.geometry = this.setupPoint(values, feature.latitude, feature.longitude);\n    } else {\n      values.geometry = null;\n    }\n\n    values.created_at = feature.clientCreatedAt || feature.createdAt;\n    values.updated_at = feature.clientUpdatedAt || feature.updatedAt;\n    values.version = feature.version;\n\n    if (values.created_by_id == null) {\n      values.created_by_id = -1;\n    }\n\n    if (values.updated_by_id == null) {\n      values.updated_by_id = -1;\n    }\n\n    values.server_created_at = feature.createdAt;\n    values.server_updated_at = feature.updatedAt;\n\n    values.created_duration = feature.createdDuration;\n    values.updated_duration = feature.updatedDuration;\n    values.edited_duration = feature.editedDuration;\n\n    values.created_latitude = feature.createdLatitude;\n    values.created_longitude = feature.createdLongitude;\n    values.created_altitude = feature.createdAltitude;\n    values.created_horizontal_accuracy = feature.createdAccuracy;\n\n    if (feature.hasCreatedCoordinate) {\n      values.created_geometry = this.setupPoint(values, feature.createdLatitude, feature.createdLongitude);\n    }\n\n    values.updated_latitude = feature.updatedLatitude;\n    values.updated_longitude = feature.updatedLongitude;\n    values.updated_altitude = feature.updatedAltitude;\n    values.updated_horizontal_accuracy = feature.updatedAccuracy;\n\n    if (feature.hasUpdatedCoordinate) {\n      values.updated_geometry = this.setupPoint(values, feature.updatedLatitude, feature.updatedLongitude);\n    }\n\n    return values;\n  }\n\n  static deleteRowsForRecordStatement(db, record, tableName) {\n    return db.deleteStatement(tableName, {record_resource_id: record.id});\n  }\n\n  static deleteRowsStatement(db, tableName) {\n    return db.deleteStatement(tableName, {});\n  }\n\n  static deleteForRecordStatements(db, record, form) {\n    const repeatables = form.elementsOfType('Repeatable');\n\n    const statements = [];\n\n    let tableName = this.tableNameWithForm(form, null);\n\n    statements.push(this.deleteRowsForRecordStatement(db, record, tableName));\n\n    for (const repeatable of repeatables) {\n      tableName = this.tableNameWithForm(form, repeatable);\n\n      statements.push(this.deleteRowsForRecordStatement(db, record, tableName));\n    }\n\n    tableName = this.multipleValueTableNameWithForm(form);\n\n    statements.push(this.deleteRowsForRecordStatement(db, record, tableName));\n\n    return statements;\n  }\n\n  static deleteForFormStatements(db, form) {\n    const repeatables = form.elementsOfType('Repeatable');\n\n    const statements = [];\n\n    let tableName = this.tableNameWithForm(form, null);\n\n    statements.push(this.deleteRowsStatement(db, tableName));\n\n    for (const repeatable of repeatables) {\n      tableName = this.tableNameWithForm(form, repeatable);\n\n      statements.push(this.deleteRowsStatement(db, tableName));\n    }\n\n    tableName = this.multipleValueTableNameWithForm(form);\n\n    statements.push(this.deleteRowsStatement(db, tableName));\n\n    return statements;\n  }\n\n  static multipleValueTableNameWithForm(form) {\n    return format('account_%s_form_%s_values', form._accountRowID, form.rowID);\n  }\n\n  static tableNameWithForm(form, repeatable) {\n    if (repeatable == null) {\n      return format('account_%s_form_%s', form._accountRowID, form.rowID);\n    }\n\n    return format('account_%s_form_%s_%s', form._accountRowID, form.rowID, repeatable.key);\n  }\n\n  static setupSearch(values, feature) {\n    const searchableValue = feature.searchableValue;\n\n    values.record_index_text = searchableValue;\n    values.record_index = {raw: `to_tsvector(${ pgformat('%L', searchableValue) })`};\n\n    return values;\n  }\n\n  static setupPoint(values, latitude, longitude) {\n    const wkt = pgformat('POINT(%s %s)', longitude, latitude);\n\n    return {raw: `ST_Force2D(ST_SetSRID(ST_GeomFromText('${ wkt }'), 4326))`};\n  }\n}\n"]}